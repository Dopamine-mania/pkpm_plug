# 20260112 客户反馈 → 黑匣子自检项对照表

说明：下列自检项均以控制台统一格式输出：`[CHECK] item expected=... actual=... => PASS/FAIL`；`STRICT_CHECK` 失败会直接 `RuntimeError` 中断。

## 1) 运行稳定性（“删两行才能跑”）
- 关联问题：洞口/后浇段变量未定义导致 `NameError`、工具函数被覆盖导致 `TypeError`。
- 证据项：
  - `hole.cast.segment`、`hole.cast.inner_surfs`（不存在则 `expected=False`/或按需 `skipped`，避免引用未定义变量）
  - `util._nid.callable`（防止 `_nid` 被误覆盖为 int 导致 `'int' object is not callable`）

## 2) 洞口两侧箍筋高度（上下端应到梁顶/梁底）
- 证据项：`hole.side_stirrup.full_height.left`、`hole.side_stirrup.full_height.right`

## 3) 预应力孔道与洞口干涉（孔道高度落在洞口范围）
- 证据项：`duct.z_avoid_hole`（孔道中心Z不得落入任何洞口Z区间）

## 4) 上翼缘配筋补齐（翼缘范围的纵筋/箍筋）
- 证据项：
  - `rebar.corner.top`（上翼缘左右角部纵筋存在）
  - `stirrup.ring13.segments`（工字型箍筋闭合 + 封口筋，包含上部围束）

## 5) 洞口顶部/底部“小梁”加强箍筋及逻辑
- 证据项：`hole.small_beam_stirrup.top`、`hole.small_beam_stirrup.bottom`

## 6) 底部翼缘顶部角筋（角点至少要有钢筋）
- 证据项：`rebar.corner.bottom_top`

## 7) 均布荷载不要用节点力模拟（改为面荷载）
- 证据项：
  - `load.uniform.mode`（应为 `Ebsload`）
  - `load.uniform.surface_esides`（必须 `>0`）
  - `load.uniform.applied`（必须 `True`，并打印 `source=` 便于定位取面路径）
  - `load.uniform.value_raw`（与Excel期望值误差 `<=0.1%`）
  - `load.uniform.pressure`（由 `kN/m → kN/mm^2` 换算后的压力，需 `>0` 且打印 `width=`）

## 8) 荷载在网格划分后的传递（兼容性自证）
- 证据项：同第 7)（面荷载会随实体/面进入分析模型，不依赖节点数均分）

## 9) 支座/约束在模型树中对象化显示（用 Nset 定义）
- 证据项：
  - `support.left.nset.id`、`support.right.nset.id`
  - `support.right.face_nset.id`（右端端面集合，供网格后拾取）
  - `support.ref_points`（两端参考点必须存在）
  - `support.post_mesh_mode`（已切换为“网格后耦合流”）
  - `support.left.fixed.uses_nset`、`support.right.fixed.uses_nset`
  - `support.right.linear_nodes`（右端简支取“一排底边点”，而非仅两角点）
  - `coupling.registered`（左端面 Coupling 必须注册成功，力学核心）

> 2026-01-13 更新：PKPM 官方建议“网格后在有限元环境创建 Coupling/支座”，因此脚本默认 `POST_MESH_SUPPORT=True`：
> - `coupling.registered` 将输出 `skipped`
> - `support.left/right.fixed.uses_nset` 将输出 `skipped`
> - 新增 `coupling.skipped`、`support.fixed.skipped` 作为证据项

## 10) 网格报错（拓扑/几何闭合兜底）
- 证据项：
  - `topo.merge_nodes`（best-effort 合并重合节点，打印可用方法名/错误）
  - `duct.within_web_y`、`duct.within_web_z`（孔道不得突出构件）
  - `hole.hp_inners.precast`、`hole.hp_inners.cast`（洞口跨叠合面时清理“洞内薄片”）
  - `rebar.hole_void.edges`（洞口真空区禁止钢筋穿越）

## 11) 材料/截面自动指派（客户验收项）
- 证据项：
  - `material.precast.id`、`material.cast.id`
  - `section.precast.id`、`section.cast.id`
  - `solid.web_precast.sid`、`solid.cast.sid`（Solid.sid 应绑定对应 Section.id）
