【打包阶段踩坑 & 流程化处理清单】(内部)

目标：交付“客户可傻瓜运行”的 onefile EXE，同时保留源码排障能力；并把环境差异导致的问题可复现、可诊断、可闭环。

一、启动阶段（bat/环境）常见坑
1) bat 行尾不是 CRLF（只有 LF）
   - 现象：cmd 解析错行，出现“'al' 不是内部或外部命令”、“'5001' 不是命令”等离奇报错，甚至日志都写不出来。
   - 处理：确保所有 .bat 都是 CRLF 行尾；交付前用工具统一转换（当前包已处理）。

2) 同一台电脑多个 Python（py/pyw + Anaconda + WindowsApps）
   - 现象：双击 bat 时选错解释器，PyQt5/依赖缺失导致闪退；但“调试版 bat”用另一个 python 又能跑。
   - 处理：
     - 启动器会探测可用 python，并以“能 import PyQt5”为准选择；
     - 自动跳过 WindowsApps 的 python.exe 别名；
     - 保留 运行_UI界面_调试.bat 作为“必出 traceback”的兜底。

3) pythonw + cmd /c 的引号拼接
   - 现象：命令行里出现 \"D:\...\pythonw.exe\" 这种字面量，cmd 会当成命令名导致失败。
   - 处理：不要拼 cmd /c 字符串去转义引号；改用 start "" "pythonw.exe" script.py 直启。

二、PyInstaller onefile 运行期常见坑
1) runpy.run_path 在 onefile 下不稳定
   - 现象：EXE 报 ImportError: can't find '__main__' module in ...\ui_main_pro.py
   - 根因：onefile 解压到 _MEI 临时目录后，runpy 对“路径脚本”的解析行为不一致。
   - 处理：launch_ui.py 采用正常 import：import ui_main_pro; ui_main_pro.main()

2) EXE 模式输出目录不可见（写进 _MEIPASS/_MEI）
   - 现象：UI 不选 Excel 时，用 UI 参数生成临时 Excel，输出脚本也落在临时目录，用户找不到。
   - 处理：UI 参数模式下，固定把 temp_ui_params.xlsx 与 pkpm_composite_beam_model.py 输出到 exe 所在目录（sys.executable 目录）。

三、打包环境/依赖常见坑
1) pip TLS/代理错误（例如 ValueError: check_hostname requires server_hostname）
   - 现象：用 venv 方案安装依赖/升级 pip 直接失败。
   - 处理：
     - 优先使用“已有 Anaconda 环境”打包：打包EXE_使用当前Python环境.bat
     - 必要时关闭抓包代理/VPN；或临时设置镜像：set PIP_INDEX_URL=https://pypi.org/simple

2) 环境污染（invalid distribution -umpy / numpy/pandas/openpyxl 版本混乱）
   - 现象：PyInstaller 分析阶段崩、卡死或打出来的 exe 启动异常。
   - 处理：
     - build_exe.py 统一设置 PYTHONNOUSERSITE=1，避免混入用户目录 site-packages
     - 代码侧避免静态依赖 pandas/numpy/openpyxl：ExcelParser 默认走 stdlib 最小 xlsx 解析，pandas 为可选动态导入
     - build_exe.py 增加 --exclude-module pandas/numpy/openpyxl，强制不打包这些大依赖

四、推荐交付流程（可复制粘贴执行）
1) 确保 UI 在源码模式可运行：双击 运行_UI界面.bat
2) Windows 上生成 EXE：
   - Anaconda Prompt (base)：
     - cd /d <pkpm_composite_beam 目录>
     - set PYTHONNOUSERSITE=1
     - D:\Study\Anaconda\python.exe build_exe.py
3) 运行 dist/PKPM叠合梁工具.exe 自测：读取示例 Excel，生成 pkpm_composite_beam_model.py
4) 打包客户交付包（含 exe + 示例 + 诊断）：运行 打包交付包_EXE.bat

五、客户现场问题闭环
1) 客户反馈“打不开/闪退”：
   - 让客户先运行 一键诊断.bat，把 diag.log 发回
2) 客户反馈“运行但没生成脚本/找不到输出”：
   - 确认输出路径：选 Excel 时输出到 Excel 同目录；UI 参数模式输出到 exe 同目录。

